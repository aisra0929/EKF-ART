const SUPABASE_URL = 'https://sxfwqdxkvcxxbbnvwaki.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4ZndxZHhrdmN4eGJibnZ3YWtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjQzNTYsImV4cCI6MjA4NTgwMDM1Nn0.skux7wINToP4i4GfBU_8x3F_nwcSgJiwgcCWfGD0zIA'; 
const _client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let state = {
    editingId: null
};

// --- INITIALIZATION ---
window.onload = () => {
    loadAdminDashboard();
    generateCompetitorFields(); // Initialize default list (8)
};

// --- MODAL CONTROLS ---
function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
    state.editingId = null;
}

function openCreateModal() {
    state.editingId = null;
    document.getElementById('modal-title').innerText = "Initialize New Tournament";
    // Reset fields
    document.getElementById('t-name').value = "";
    document.getElementById('t-comp-size').value = "8";
    generateCompetitorFields();
    document.getElementById('manage-modal').classList.remove('hidden');
}

// --- DYNAMIC INPUT LOGIC ---
function generateCompetitorFields() {
    const size = parseInt(document.getElementById('t-comp-size').value);
    const container = document.getElementById('dynamic-competitors');
    container.innerHTML = ""; // Clear existing

    for (let i = 1; i <= size; i++) {
        const div = document.createElement('div');
        div.className = 'comp-input-wrapper';
        div.innerHTML = `
            <span class="comp-number">${i}.</span>
            <input type="text" class="comp-name-input" placeholder="Competitor Name" data-index="${i}">
        `;
        container.appendChild(div);
    }
}

// --- DATA LOADING ---
async function loadAdminDashboard() {
    const { data: tours, error } = await _client
        .from('tournaments')
        .select(`*, competitors(count)`)
        .order('created_at', { ascending: false });

    if (error) return console.error("Load Error:", error);

    const grid = document.getElementById('tournament-grid');
    document.getElementById('t-count').innerText = tours.length;

    grid.innerHTML = tours.map(t => {
        const compCount = t.competitors[0]?.count || 0;
        return `
        <div class="t-card">
            <span class="status-pill">${t.status}</span>
            <h3 style="margin: 12px 0 5px 0;">${t.name}</h3>
            <div style="font-size:0.85rem; color:#64748b; margin-bottom: 20px;">
                <p><strong>Bracket:</strong> ${compCount} Players</p>
                <p><strong>Type:</strong> ${t.kata_type || 'Single'} | ${t.gender || 'Mixed'}</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1; padding:8px" onclick="viewCodes('${t.id}')"><i class="fas fa-key"></i> Codes</button>
                <button class="btn-ghost" style="color:red; border-color:#fecaca" onclick="deleteTournament('${t.id}')"><i class="fas fa-trash"></i></button>
            </div>
        </div>`;
    }).join('');
}

// --- SAVE LOGIC ---
async function saveTournament() {
    const name = document.getElementById('t-name').value.trim();
    const min = parseInt(document.getElementById('t-min').value) || 0;
    const sec = parseInt(document.getElementById('t-sec').value) || 0;
    const totalSec = (min * 60) + sec;
    const jCount = parseInt(document.getElementById('t-jcount').value);
    const gender = document.getElementById('t-gender').value;
    const kataType = document.getElementById('t-kata-type').value;

    // Collect competitor names from dynamic inputs
    const compInputs = document.querySelectorAll('.comp-name-input');
    const compsRaw = Array.from(compInputs)
        .map(input => input.value.trim())
        .filter(val => val !== "");

    if (!name || compsRaw.length === 0) return alert("Missing Tournament Name or Competitors.");

    const shortId = "T" + Math.floor(1000 + Math.random() * 9000);

    // Insert Tournament (Added gender/kataType to payload)
    const { data: t, error } = await _client.from('tournaments').insert({
        name, 
        short_id: shortId, 
        performance_time: totalSec, 
        judge_count: jCount,
        gender: gender,
        kata_type: kataType,
        status: 'live', 
        remaining_time_seconds: totalSec, 
        timer_status: 'idle'
    }).select().single();

    if (error) return alert(error.message);

    // Insert Competitors
    await _client.from('competitors').insert(compsRaw.map((name, i) => ({
        tournament_id: t.id, name: name, order_index: i + 1
    })));

    // Auto-assign first
    const { data: first } = await _client.from('competitors')
        .select('id').eq('tournament_id', t.id).order('order_index').limit(1).single();
    
    await _client.from('tournaments').update({ current_competitor_id: first.id }).eq('id', t.id);

    // Generate Role Access Codes
    const supervisorCode = Math.floor(100000 + Math.random() * 900000).toString();
    await _client.from('judges').insert({ tournament_id: t.id, judge_code: supervisorCode, role: 'supervisor' });

    for (let i = 0; i < jCount; i++) {
        const jCode = Math.floor(100000 + Math.random() * 900000).toString();
        await _client.from('judges').insert({ tournament_id: t.id, judge_code: jCode, role: 'judge' });
    }

    closeModal('manage-modal');
    loadAdminDashboard();
}

// --- CREDENTIALS & DELETE ---
async function viewCodes(tId) {
    const { data: t } = await _client.from('tournaments').select('short_id').eq('id', tId).single();
    const { data: js } = await _client.from('judges').select('*').eq('tournament_id', tId);

    let str = `TOURNAMENT ID: ${t.short_id}\n\n`;
    js.forEach(j => {
        str += `${j.role.toUpperCase()}: ${j.judge_code}\n`;
    });

    document.getElementById('codes-display').innerText = str;
    document.getElementById('codes-modal').classList.remove('hidden');
}

async function deleteTournament(tId) {
    if (confirm("Permanently delete this tournament and all scores?")) {
        await _client.from('tournaments').delete().eq('id', tId);
        loadAdminDashboard();
    }
}