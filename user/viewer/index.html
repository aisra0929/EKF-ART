<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKF Official Scoreboard | Live Results</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           EKF IMAGE-PERFECT STYLING
           ========================================= */
        :root {
            --bg-black: #000000;
            --ao-blue: #0055a4;
            --aka-red: #c8102e;
            --text-white: #ffffff;
            --border-white: #ffffff;
            --grey-text: #888888;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg-black);
            color: var(--text-white);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            height: 100vh;
        }

        .hidden { display: none !important; }

        /* SELECTION SCREEN */
        .selection-screen {
            max-width: 800px; margin: 100px auto; text-align: center; padding: 20px;
        }
        .t-list { display: grid; gap: 15px; margin-top: 30px; }
        .t-item { 
            background: #111; border: 1px solid #333; padding: 20px; border-radius: 10px; 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .t-item:hover { border-color: var(--ao-blue); }

        /* HEADER */
        .ekf-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 40px; border-bottom: 1px solid #222;
        }
        .flag-logo { height: 90px; }
        .header-center { text-align: center; flex: 1; }
        .header-center h1 { font-size: 5rem; font-weight: 900; letter-spacing: 2px; }
        .supervisor-name { color: var(--grey-text); font-size: 1.2rem; margin-top: 5px; }
        .header-line { width: 400px; height: 1px; background: #333; margin: 10px auto; }

        /* MAIN SCORING AREA */
        .scoring-arena {
            display: grid; grid-template-columns: 1fr 1fr; gap: 60px; padding: 20px 80px;
        }

        .side-label {
            width: 100%; padding: 10px; font-size: 2.2rem; font-weight: 900;
            text-align: center; border-radius: 8px; margin-bottom: 20px; letter-spacing: 4px;
        }
        .blue-bar { background: var(--ao-blue); }
        .red-bar { background: var(--aka-red); }

        /* Large Digital Score Box */
        .score-box-large {
            width: 320px; height: 260px; background: #000; border: 4px solid #333;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; position: relative; margin-bottom: 30px;
        }
        .score-val-large { font-size: 14rem; font-weight: bold; line-height: 1; }

        /* Judge Small Boxes underneath */
        .judge-boxes-container { display: flex; gap: 10px; margin-top: 10px; }
        .j-box {
            width: 85px; height: 85px; border: 3px solid var(--border-white);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; font-weight: 900; background: #000;
        }
        .j-label { font-size: 0.8rem; color: #fff; margin-top: 8px; font-weight: bold; text-align: center; }

        .side-stack { display: flex; flex-direction: column; align-items: center; }

        /* PERFORMER INFO (Under AO) */
        .performer-info { margin-top: 20px; text-align: center; }
        .performer-info h3 { font-size: 2rem; color: #fff; }
        .performer-info p { color: var(--ao-blue); font-weight: bold; font-size: 1.2rem; }

        /* BRACKET SECTION */
        .bracket-section {
            margin: 40px 80px; background: #080808; border-radius: 20px; padding: 30px;
            border: 1px solid #1a1a1a;
        }
        .bracket-header { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .bracket-title { font-size: 1.5rem; font-weight: 900; letter-spacing: 1px; }

        .bracket-grid { display: flex; gap: 40px; }
        .round-col { flex: 1; }
        .round-name { color: var(--grey-text); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 15px; }
        
        .match-card {
            background: #000; border: 1px solid #222; border-radius: 8px;
            padding: 10px; margin-bottom: 15px; width: 220px;
        }
        .match-player { padding: 8px; border-bottom: 1px solid #111; font-size: 0.9rem; font-weight: 600; display: flex; justify-content: space-between; }
        .match-player:last-child { border: none; }
        .match-player.winner { color: var(--accent-gold); }

        .m-id { font-size: 0.6rem; color: #444; margin-bottom: 5px; }

        @media (max-width: 1400px) {
            .header-center h1 { font-size: 3rem; }
            .score-box-large { width: 240px; height: 200px; }
            .score-val-large { font-size: 10rem; }
            .j-box { width: 60px; height: 60px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- 1. TOURNAMENT SELECTION -->
    <div id="selection-screen" class="selection-screen">
        <img src="assets/left-flag.png" style="height: 60px;">
        <h1>EKF OFFICIAL SCOREBOARD</h1>
        <div id="tournament-list" class="t-list">
            <!-- Dynamic List -->
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="dashboard-screen" class="hidden">
        <header class="ekf-header">
            <img src="assets/left-flag.png" class="flag-logo" onerror="this.src='https://via.placeholder.com/100x80?text=FLAG'">
            <div class="header-center">
                <h1>EKF SCOREBOARD</h1>
                <div class="supervisor-name" id="display-t-name">OFFICIAL TOURNAMENT</div>
                <div class="header-line"></div>
            </div>
            <img src="assets/right-flag.png" class="flag-logo" onerror="this.src='https://via.placeholder.com/100x80?text=LOGO'">
        </header>

        <main class="scoring-arena">
            <!-- AO SIDE (CURRENT) -->
            <section class="side-stack">
                <div class="side-label blue-bar">AO</div>
                <div class="score-box-large">
                    <span id="ao-total" class="score-val-large">0</span>
                </div>
                
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div id="ao-judges" class="judge-boxes-container">
                        <!-- 5 Boxes matching image -->
                    </div>
                    <div id="ao-labels" style="display: flex; gap: 10px;">
                        <!-- Labels Judge 1...5 -->
                    </div>
                </div>

                <div class="performer-info">
                    <h3 id="ao-name">---</h3>
                    <p id="ao-art">---</p>
                </div>
            </section>

            <!-- AKA SIDE (LEADER) -->
            <section class="side-stack">
                <div class="side-label red-bar">AKA</div>
                <div class="score-box-large">
                    <span id="aka-total" class="score-val-large">0</span>
                </div>

                <div id="aka-judges" class="judge-boxes-container">
                    <!-- Boxes for High Score comparison -->
                </div>
                <div id="aka-labels" style="display: flex; gap: 10px;"></div>

                <div class="performer-info">
                    <h3 id="aka-name">CURRENT LEADER</h3>
                    <p id="aka-art">HIGH SCORE</p>
                </div>
            </section>
        </main>

        <!-- BRACKET SECTION -->
        <section class="bracket-section">
            <div class="bracket-header">
                <div class="bracket-title">TOURNAMENT BRACKET</div>
                <div style="color: #444; font-weight: bold; font-size: 0.8rem;">ROUND 1 • MATCH 1 • KATA</div>
            </div>
            
            <div id="bracket-grid" class="bracket-grid">
                <!-- Dynamically generated matches -->
            </div>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'https://sxfwqdxkvcxxbbnvwaki.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4ZndxZHhrdmN4eGJibnZ3YWtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjQzNTYsImV4cCI6MjA4NTgwMDM1Nn0.skux7wINToP4i4GfBU_8x3F_nwcSgJiwgcCWfGD0zIA'; 
        const _client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = { activeT: null, competitors: [], judges: [], scores: [] };

        // 1. DATA LOAD
        async function fetchTournaments() {
            const { data } = await _client.from('tournaments').select('*').neq('status','archived').order('created_at',{ascending:false});
            const list = document.getElementById('tournament-list');
            list.innerHTML = data.map(t => `<div class="t-item" onclick="initDashboard('${t.id}')"><h3>${t.name}</h3><span>ID: ${t.short_id}</span></div>`).join('');
        }

        async function initDashboard(id) {
            const { data: t } = await _client.from('tournaments').select('*').eq('id', id).single();
            state.activeT = t;
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            document.getElementById('display-t-name').innerText = t.name;

            await refreshData();
            initRealtime();
        }

        async function refreshData() {
            const tid = state.activeT.id;
            const { data: comps } = await _client.from('competitors').select('*').eq('tournament_id', tid).order('order_index');
            const { data: judges } = await _client.from('judges').select('*').eq('tournament_id', tid).eq('role', 'judge');
            const { data: scores } = await _client.from('scores').select('*').eq('tournament_id', tid);

            state.competitors = comps;
            state.judges = judges;
            state.scores = scores;

            renderScores();
            renderBracket();
        }

        function initRealtime() {
            _client.channel('view-sync').on('postgres_changes', {event:'*', schema:'public'}, () => refreshData()).subscribe();
        }

        // 2. SCORE RENDERING (Matches image layout)
        function renderScores() {
            const t = state.activeT;
            const current = state.competitors.find(c => c.id === t.current_competitor_id);
            const highComp = [...state.competitors].sort((a,b) => getSum(b.id) - getSum(a.id))[0];

            // AO (Current)
            if(current) {
                document.getElementById('ao-name').innerText = current.name;
                document.getElementById('ao-art').innerText = current.art_type || "No Art Set";
                document.getElementById('ao-total').innerText = getSum(current.id).toFixed(0);
                
                const currScores = state.scores.filter(s => s.competitor_id === current.id);
                renderJudgeRow('ao-judges', 'ao-labels', currScores);
            }

            // AKA (Leader)
            if(highComp && getSum(highComp.id) > 0) {
                document.getElementById('aka-name').innerText = highComp.name;
                document.getElementById('aka-total').innerText = getSum(highComp.id).toFixed(0);
                const leaderScores = state.scores.filter(s => s.competitor_id === highComp.id);
                renderJudgeRow('aka-judges', 'aka-labels', leaderScores);
            }
        }

        function renderJudgeRow(containerId, labelId, scoresList) {
            const container = document.getElementById(containerId);
            const labelContainer = document.getElementById(labelId);
            container.innerHTML = "";
            labelContainer.innerHTML = "";

            // Use 5 boxes as per image or actual judge count
            const count = state.judges.length || 5;
            for(let i=0; i<count; i++) {
                const s = scoresList.find(sc => sc.judge_id === state.judges[i]?.id);
                container.innerHTML += `<div class="j-box">${s ? s.score_value.toFixed(1) : ''}</div>`;
                labelContainer.innerHTML += `<div style="width:85px" class="j-label">Judge ${i+1}</div>`;
            }
        }

        function getSum(compId) {
            return state.scores.filter(s => s.competitor_id === compId).reduce((a,b) => a + parseFloat(b.score_value), 0);
        }

        // 3. BRACKET GENERATION
        function renderBracket() {
            const grid = document.getElementById('bracket-grid');
            grid.innerHTML = "";
            
            // Round 1
            let r1Html = `<div class="round-col"><div class="round-name">Round 1</div>`;
            for(let i=0; i < state.competitors.length; i+=2) {
                const c1 = state.competitors[i];
                const c2 = state.competitors[i+1];
                r1Html += `
                    <div class="match-card">
                        <div class="m-id">R1-M${(i/2)+1}</div>
                        <div class="match-player">${c1 ? c1.name : 'TBD'}</div>
                        <div class="match-player">${c2 ? c2.name : 'TBD'}</div>
                    </div>`;
            }
            r1Html += `</div>`;

            // Round 2 (Placeholder matches visual)
            let r2Html = `<div class="round-col"><div class="round-name">Round 2</div>`;
            r2Html += `
                <div class="match-card" style="margin-top:40px;">
                    <div class="m-id">R2-M1</div>
                    <div class="match-player">TBD</div>
                    <div class="match-player">TBD</div>
                </div>`;
            r2Html += `</div>`;

            grid.innerHTML = r1Html + r2Html;
        }

        window.onload = fetchTournaments;
    </script>
</body>
</html>